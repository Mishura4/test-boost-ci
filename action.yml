name: "Install boost"
description: "Build or retrieve boost & set paths"
inputs:
  version:
    description: "Version of boost to install"
    required: false
    default: 'latest'
  download-url:
    description: "Where to download the archive from"
    required: false
  variant:
    description: "Variants to build"
    required": false
    default: debug,release
  toolset:
    description: "Toolset to use"
    required: true
  runtime-link:
    description: "How to link the runtime library"
    required: false
    default: static,shared
  threading:
    description: "Threading mode to use"
    required: false
    default: multi,single
  link:
    description: "How to link boost"
    required: false
    default: static
  cxxstd:
    description: "C++ standard to use (restricts which libraries are built)"
    required: false
    default: static
outputs:
  boostdir:
    description: "Path at which boost was installed"
runs:
  using: "composite"
  steps:
    - name: Setup
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo BOOST_TAG="${{ inputs.version == 'latest' && '`gh release view -R boostorg/boost --jq ".name" --json name`' || format('boost-{0}', inputs.version) }}" >> $GITHUB_ENV

    - name: Restore boost
      id: restore-boost
      uses: actions/cache/restore@v4
      with:
        path: '${{ github.workspace }}/boost-install'
        key: boost-${{ env.BOOST_TAG }}-${{ inputs.toolset }}-${{ inputs.variant }}-${{ inputs.link }}-${{ inputs.runtime-link }}-${{ inputs.threading }}-${{ inputs.cxxstd }}

    - name: Add MSBuild to PATH
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@6fb02220983dee41ce7ae257b6f4d8f9bf5ed4ce # v2

    - name: Download Boost source
      id: checkout-boost
      env:
        GH_TOKEN: ${{ github.token }}
      shell: bash
      run: |
        archive='boost-${{ inputs.boost }}' &&
        gh release download ${{ env.BOOST_TAG }} -R boostorg/boost -p 'boost-*-b2-nodocs.7z' -O "$archive".7z --clobber &&
        7z x "$archive".7z -spe &&
        mv $archive boost

    - name: Build boost
      shell: bash
      run: |
        mkdir boost-install && (cd boost && ./bootstrap.sh msvc && ./b2 install --prefix="../boost-install" -q toolset=msvc variant=${{ inputs.build == 'Debug' && 'debug' || 'release' }} cxxstd=latest runtime-link=static address-model=64 threading=multi link=static)

    - name: Cache boost
      id: cache-boost
      uses: actions/cache/save@v4
      with:
        path: 'boost-install'
        key: ${{ steps.restore-boost.outputs.cache-primary-key }}